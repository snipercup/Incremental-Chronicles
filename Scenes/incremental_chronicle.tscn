[gd_scene load_steps=6 format=3 uid="uid://c1t2j0vipmnu6"]

[ext_resource type="Script" uid="uid://cvcr36wahxv8u" path="res://Scripts/incremental_chronicle.gd" id="1_4denh"]
[ext_resource type="Script" uid="uid://cgfd5l1hpfvn" path="res://Scripts/story_points_label.gd" id="3_67ln1"]
[ext_resource type="Script" uid="uid://qqhvylrnpjep" path="res://Scripts/action_generator.gd" id="3_rorxs"]
[ext_resource type="Script" uid="uid://d1354ddbnb5hl" path="res://Scripts/action_list.gd" id="4_67ln1"]

[sub_resource type="NobodyWhoSampler" id="NobodyWhoSampler_rorxs"]
use_grammar = true
gbnf_grammar = "root ::= \"{\" ws01 root-message \"}\" ws01
root-message ::= \"\\\"message\\\"\" \":\" ws01 string


value  ::= (object | array | string | number | boolean | null) ws

object ::=
  \"{\" ws (
    string \":\" ws value
    (\",\" ws string \":\" ws value)*
  )? \"}\"

array  ::=
  \"[\" ws01 (
            value
    (\",\" ws01 value)*
  )? \"]\"

string ::=
  \"\\\"\" (string-char)* \"\\\"\"

string-char ::= [^\"\\\\] | \"\\\\\" ([\"\\\\/bfnrt] | \"u\" [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F] [0-9a-fA-F]) # escapes

number ::= integer (\".\" [0-9]+)? ([eE] [-+]? [0-9]+)?
integer ::= \"-\"? ([0-9] | [1-9] [0-9]*)
boolean ::= \"true\" | \"false\"
null ::= \"null\"

# Optional space: by convention, applied in this grammar after literal chars when allowed
ws ::= ([ \\t\\n] ws)?
ws01 ::= ([ \\t\\n])?"
seed = 1232

[node name="IncrementalChronicle" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 3
size_flags_vertical = 3
script = ExtResource("1_4denh")

[node name="LLM" type="Node" parent="."]

[node name="NobodyWhoModel" type="NobodyWhoModel" parent="LLM"]
model_path = "/home/user/.local/share/godot/app_userdata/Incremental-Chronicles/gemma-2-2b-it-Q4_K_M.gguf"

[node name="ActionGenerator" type="NobodyWhoChat" parent="LLM" node_paths=PackedStringArray("model_node")]
model_node = NodePath("../NobodyWhoModel")
sampler = SubResource("NobodyWhoSampler_rorxs")
system_prompt = "You are a story writing assistant. Your job is to create short messages (up to 20 words). The message contains an action or dialogue in the following context: You are in a simple medieval fantasy village with a school, a church and is connected trough dirt roads. The village is bustling with life and there is plenty to do."
script = ExtResource("3_rorxs")

[node name="MainWindow" type="HBoxContainer" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="PlayerStats" type="VBoxContainer" parent="MainWindow"]
layout_mode = 2

[node name="StoryPointsLabel" type="Label" parent="MainWindow/PlayerStats" node_paths=PackedStringArray("action_list")]
layout_mode = 2
text = "Story points: 0/100"
script = ExtResource("3_67ln1")
action_list = NodePath("../../ActionList")

[node name="ReincarnateButton" type="Button" parent="MainWindow/PlayerStats"]
layout_mode = 2
text = "Reincarnate"

[node name="ActionList" type="VBoxContainer" parent="MainWindow" node_paths=PackedStringArray("action_generator")]
layout_mode = 2
size_flags_horizontal = 3
script = ExtResource("4_67ln1")
action_generator = NodePath("../../LLM/ActionGenerator")
